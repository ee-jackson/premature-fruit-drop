---
title: "Phylogenetic Signal"
author: "E.E. Jackson"
date: '`r format(Sys.time(), "%d %B, %Y")`'
output: pdf_document
---

# Packages and Data

```{r, message=FALSE, warning=FALSE}
rm(list=ls())

require(knitr)
require(phytools)
require(caper)
require(picante)
require(geiger)
require(tidyverse)
require(ggplot2)
require(ggpubr)
#require(phylolm)

select<- dplyr::select # to ensure dplyr version of select is default
```

```{r}
SD<-readr::read_csv("../output/tables/summarizeSeedRain.csv")
TidyTrait<- readr::read_csv('../data/TidyTrait.csv')
PhyloExtraSpec<-read.tree('../data/PhyloExtraSpec.tree')
Trait<-left_join(SD, TidyTrait, by=c("sp" = "Codigo"))
```

```{r}
Trait<-subset(Trait, total_seeds>50)
Trait<-subset(Trait, select=c(proportion_abscised, proportion_abscised_w, Plant_species19, CoFruit, cvseed, Endocarp_investment, HEIGHT_AVG, FAMILY, BCIReproductive, SeedPredationRate))
t <- na.omit(Trait, cols="proportion_abscised")
t<-rename(t, taxa=Plant_species19) 

check <- geiger::name.check(phy = PhyloExtraSpec, data = t, data.names = t$taxa)
#check

newtree <- drop.tip(PhyloExtraSpec, check$tree_not_data)

# remove polytomies
newtree <- multi2di(newtree, random = TRUE)

#label nodes
newtree$node.label <- 1:length(newtree$node.label)

# Make sure edge length isn't zero
newtree$edge.length  <-newtree$edge.length +0.001

# Put them in the right order:
t <- t[   match(newtree$tip.label, t$taxa),   ] 


```
The strongest argument for Pagel’s Lambda is that it provides a reliable effect size measure besides testing for phylogenetic signal.

Often people will mention that they “corrected for phylogeny” because of the phylogenetic signal in their variables. However, we do not correct for phylogeny because our variables show phylogenetic signal. We account for phylogenetic non-independence because the residuals from our models show phylogenetic signal – see Revell 2010 Methods in Ecology and Evolution. Lambda
shown in PGLS models is the Lambda for the model residuals not the individual variables. PGLS models account for phylogenetic non-independence in your analyses.

```{r}

##Blomberg’s K
p_a <- t$proportion_abscised
names(p_a) <- t$taxa

p_a_w <- t$proportion_abscised_w
names(p_a_w) <- t$taxa

Kcalc(p_a[newtree$tip.label], newtree)

set.seed(1)
phylosignal(x=p_a[newtree$tip.label], phy=newtree, reps = 1000)
phylosignal(x=p_a_w[newtree$tip.label], phy=newtree, reps = 1000)


phylosig(tree = newtree, x = p_a, method = "lambda", test = TRUE)
phylosig(tree = newtree, x = p_a_w, method = "lambda", test = TRUE)

picante::phylosignal(x=p_a,phy=newtree, reps = 1000)
# PIC.variance.P =0.1848152, so not significantly different from the random values of K

phytools::phylosig(x=p_a,tree=newtree, test=TRUE, nsim = 1000) # Check using other package
# here p is 0.131

phytools::plotTree(newtree,p_a, showTipLabel=FALSE, showNodeLabel=FALSE, fsize=0.5)
contMap(newtree, p_a, fsize=0.5, type="fan")
ggsave("../output/plots/20191203/contMap.png")
```

Look at the evolutionary relationship between traits and proportion abscised using pairwise correlations correcting for the phylogeny. Relationships can be shown using phylomorphospace plots, which depict each species as a data point in a trait space, together with the phylogenetic relationship of each species point.

```{r}
## Overlap in fruit production by other species (CoFruit) ##
c_f <- t$CoFruit
names(c_f) <- t$taxa
phylosig(newtree, c_f, method="lambda",test=TRUE)

## Interannual variation in seed crop sizes ##
c_v <- t$cvseed
names(c_v) <- t$taxa
phylosig(newtree, c_v, method="lambda",test=TRUE)

## degree of investment in mechanical seed defences ##
e_i <- t$Endocarp_investment 
names(e_i) <- t$taxa
phylosig(newtree, e_i, method="lambda",test=TRUE)

## degree of investment in mechanical seed defences ##
h_a <- t$HEIGHT_AVG
names(h_a) <- t$taxa
phylosig(newtree, h_a, method="lambda",test=TRUE)

## Proportion of dissected seeds scored as predated by insects ##
s_p <- t$SeedPredationRate
names(s_p) <- t$taxa
phylosig(newtree, s_p, method="lambda",test=TRUE)


#Phenograms of pairs of traits:

X <- data.frame(c_f,p_a,c_v,e_i,h_a,s_p,logc_f=log(c_f))

phylomorphospace(newtree,X[,c(3,2)], xlab="log CoFruit",ylab="proportion abscised",label = "off", fsize=0.1) # CF vs PA
text(6,1, "Evolutionary correlation \n R=-0.66 P=3.04e-25")
ggsave("../output/plots/20191203/phylomorphospace_logCoFruit.png")

phylomorphospace(newtree,X[,c(3,2)],xlab="cvseed",ylab="proportion abscised",fsize=0.1, label="off") # PA vs D
text(3,1, "Evolutionary correlation \n R=-0.70 P=1.40e-24")

phylomorphospace(newtree,X[,c(5,2)],xlab="Average Height",ylab="proportion abscised",fsize=0.1, label="off") 
text(40,0.9, "Evolutionary correlation \n R= 0.39 P= 2.71e-05")

### pearson phylogenetic correlations ###
match(newtree$tip.label, rownames(X)) -> match
X[,][match,] -> X

## correlation between p_a & c_f
obj<-phyl.vcv(as.matrix(X[,c(1,2)]),vcv(newtree),1) 
r.xy<-cov2cor(obj$R)["p_a","c_f"]
## t-statistic & P-value
t.xy<-r.xy*sqrt((Ntip(newtree)-2)/(1-r.xy^2)) # t-value
P.xy<-2*pt(abs(t.xy),df=Ntip(newtree)-2,lower.tail=F)
r.xy # Pearson correlation 
P.xy # P-value


## correlation between p_a & c_v
obj<-phyl.vcv(as.matrix(X[,c(2,3)]),vcv(newtree),1) 
r.xy<-cov2cor(obj$R)["p_a","c_v"]
## t-statistic & P-value
t.xy<-r.xy*sqrt((Ntip(newtree)-2)/(1-r.xy^2)) # t-value
P.xy<-2*pt(abs(t.xy),df=Ntip(newtree)-2,lower.tail=F)
r.xy # Pearson correlation 
P.xy # P-value

## correlation between p_a & a_h
obj<-phyl.vcv(as.matrix(X[,c(5,2)]),vcv(newtree),1) 
r.xy<-cov2cor(obj$R)["p_a","h_a"]
## t-statistic & P-value
t.xy<-r.xy*sqrt((Ntip(newtree)-2)/(1-r.xy^2)) # t-value
P.xy<-2*pt(abs(t.xy),df=Ntip(newtree)-2,lower.tail=F)
r.xy # Pearson correlation 
P.xy # P-value

# fit a linear model to compare
fit.yx<-gls(p_a~e_i,data=as.data.frame(X),correlation=corBrownian(1,newtree))
anova(fit.yx)
summary(fit.yx)
plot(p_a ~ e_i, data = as.data.frame(X))
abline(fit.yx)
```
##Phylogenetic generalized least squares models (PGLS)

```{r}
# look to see if you can see any phylogenetic groupings in the traits
plot(proportion_abscised ~ SeedPredationRate, data = Trait, col = as.factor(Trait$FAMILY), pch = 16)

plot(proportion_abscised_w ~ SeedPredationRate, data = Trait, col = as.factor(Trait$FAMILY), pch = 16)

# To perform PGLS models in R, caper requires you to first combine the phylogeny and data into one object using the function comparative.data.

# make comparative data object and check to see what it dropped
trees <- comparative.data(phy = newtree, data =as.data.frame(t), 
                            names.col = taxa, vcv = TRUE, 
                            na.omit = TRUE, warn.dropped = TRUE)
trees$dropped$tips
trees$dropped$unmatched.rows

##pgls model, Pagel’s Lambda
lambdaPA <- pgls(proportion_abscised ~ 1, data = trees, lambda = "ML")
summary(lambdaPA)


lambdaPA <- pgls(proportion_abscised_w ~ 1, data = trees, lambda = "ML")
summary(lambdaPA)

#######

model.pgls <- pgls(proportion_abscised~SeedPredationRate, data = trees, lambda = "ML")
summary(model.pgls)

plot(p_a ~ s_p, data = as.data.frame(X))
abline(model.pgls)

#can look at the likelihood profiles for branch length transformations in PGLS models using pgls.profile

# Ideally you want a line with an obvious peak/optimum like this, rather than a flat line which would suggest Lambda could be anything. You can see that the optimum (the peak of the curve) should be the same as estimated in our PGLS model. 
lambda.profile <- pgls.profile(model.pgls, "lambda")
plot(lambda.profile)

 # The dotted red lines are the 95% confidence intervals on Lambda for our model. pgls.confint prints out these numbers in $ci.val
pgls.confint(model.pgls, "lambda")$ci.val

```
endocarp investment and cvseed have no significant phylogenetic correlation with proportion abscised. 
Average height has a p-value of 0.001161 and Adjusted R-squared is 0.0836. 
Cofruit p-value: 0.03475, Adjusted R-squared: 0.03116, 110 degrees of freedom.