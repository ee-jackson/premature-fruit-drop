# beta binomial models
Methods to test for and deal with overdispersion in binomial models
```{r}
m(list = ls())
require(tidyverse)
require(lme4)
library(knitr)
library(report)
require(MuMIn)
require(ggpubr)
require(MASS)
theme_set(theme_pubr(base_size = 15))
opts_chunk$set(tidy.opts=list(width.cutoff=50),tidy=TRUE)
require(glmmTMB)

dm <- read.csv("../output/tables/dispersalMode.csv")
fruitDatFull <- read.csv("../output/tables/fullCleanData.csv")

fruitDatFull %>%
	mutate(seedpred_pres = factor(ifelse(seedpred_pres == 0, "No", "Yes"))) %>%
	left_join(dplyr::select(dm, dispersal_mode = bio, sp), by = "sp") -> fruitDatFullFull

fruitDatFull$seed_dry_log <- log10(fruitDatFull$seed_dry)
fruitDatFull$cofruit_log <- log10(fruitDatFull$cofruit)
fruitDatFull$bcireproductive_log <- log10(fruitDatFull$bcireproductive)

overdisp_fun <- function(model) {
    rdf <- df.residual(model)
    rp <- residuals(model,type="pearson")
    Pearson.chisq <- sum(rp^2)
    prat <- Pearson.chisq/rdf
    pval <- pchisq(Pearson.chisq, df=rdf, lower.tail=FALSE)
    c(chisq=Pearson.chisq,ratio=prat,rdf=rdf,p=pval)
}

numcols <- names(fruitDat)[c(13,14,17,26:28)]
dfs <- fruitDatFull
dfs[,numcols] <- scale(dfs[,numcols])
modelb_sc <- update(modelb,data=dfs)

# original
modelb <- glmer(cbind(abscised_seeds,viable_seeds)~ cofruit_log + (year|sp), data=dfs, family=binomial(logit))

overdisp_fun(modelb)

# beta binomial
modelbb <- glmmTMB(cbind(abscised_seeds,viable_seeds)~cofruit_log + (year|sp), data=dfs, family= c(family="betabinomial",link="logit"))

overdisp_fun(modelbb)

# OLRE
obs <- seq(nrow(dfs))

modelo <- glmer(cbind(abscised_seeds,viable_seeds)~cofruit_log + (year|sp) + (1|obs), data=dfs, family=binomial(logit))

overdisp_fun(modelo)

# quasi
modelq <- MASS::glmmPQL(cbind(abscised_seeds,viable_seeds) ~ cofruit_log, random = ~ 1 | year/sp, family=quasibinomial, data=dfs)
summary(modelq)

# compare

AIC(modelb, modelbb, modelo, modelq)

```
